<!DOCTYPE html>
<html>
<head>
    <title>Car Simulation</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/plotly.js/2.11.1/plotly.min.js"></script>
    <style>
        #simulationContainer {
            position: relative;
            width: 100%;
            height: 400px;
            border: 1px solid black;
        }
        .car {
            position: absolute;
            width: 40px;
            height: 20px;
            background-color: red;
        }
        #car2 {
            background-color: blue;
        }
    </style>
    <script>
        let simulationInterval;
        let lastUpdateTime = Date.now();
        let car1Position = 0;
        let car2Position = 0;
        let car1Speed = 0;
        let car2Speed = 0;
        let timeStep = 0.01;

        function startSimulation() {
            const speed = document.getElementById('speed').value;
            const brakeDeceleration = document.getElementById('brakeDeceleration').value;
            const followDistance = document.getElementById('followDistance').value;
            const reactionTime = document.getElementById('reactionTime').value;

            fetch('/start_simulation', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
                body: `speed=${speed}&brakeDeceleration=${brakeDeceleration}&followDistance=${followDistance}&reactionTime=${reactionTime}`
            }).then(() => {
                if (simulationInterval) {
                    clearInterval(simulationInterval);
                }
                simulate();
            });
        }

        function simulate() {
            simulationInterval = setInterval(() => {
                fetch('/get_data')
                    .then(response => response.json())
                    .then(data => {
                        const currentTime = Date.now();
                        const elapsedTime = (currentTime - lastUpdateTime) / 1000;
                        lastUpdateTime = currentTime;

                        car1Position += car1Speed * elapsedTime;
                        car2Position += car2Speed * elapsedTime;

                        document.getElementById('car1').style.left = car1Position + 'px';
                        document.getElementById('car2').style.left = car2Position + 'px';

                        const speedData = [
                            {
                                x: data.time,
                                y: data.car1_speed,
                                type: 'scatter',
                                mode: 'lines',
                                name: 'Car 1 Speed',
                                line: {color: 'red'}
                            },
                            {
                                x: data.time,
                                y: data.car2_speed,
                                type: 'scatter',
                                mode: 'lines',
                                name: 'Car 2 Speed',
                                line: {color: 'blue'}
                            }
                        ];
                        const speedLayout = {
                            title: 'Speed vs Time',
                            xaxis: {title: 'Time (s)'},
                            yaxis: {title: 'Speed (mph)', range: [0, 100]}
                        };
                        Plotly.react('speedChart', speedData, speedLayout);

                        const distanceData = [
                            {
                                x: data.time,
                                y: data.distance,
                                type: 'scatter',
                                mode: 'lines',
                                name: 'Distance',
                                line: {color: 'green'}
                            }
                        ];
                        const distanceLayout = {
                            title: 'Distance vs Time',
                            xaxis: {title: 'Time (s)'},
                            yaxis: {title: 'Distance (inches)', range: [0, 2500]}
                        };
                        Plotly.react('distanceChart', distanceData, distanceLayout);
                    });
            }, 100); // Update every 100 ms
        }
    </script>
</head>
<body>
    <h1>Car Simulation</h1>
    <label>Speed (mph): <input type="number" id="speed" value="60"></label><br>
    <label>Brake Deceleration Factor: <input type="number" id="brakeDeceleration" value="1.0"></label><br>
    <label>Follow Distance (inches): <input type="number" id="followDistance" value="100"></label><br>
    <label>Reaction Time (s): <input type="number" id="reactionTime" value="1.5"></label><br>
    <button onclick="startSimulation()">Start Simulation</button>
    
    <div id="simulationContainer">
        <div id="car1" class="car"></div>
        <div id="car2" class="car" style="top: 30px;"></div>
    </div>
    
    <div id="speedChart" style="width: 100%; height: 400px;"></div>
    <div id="distanceChart" style="width: 100%; height: 400px;"></div>
</body>
</html>
